"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.isProfileDecorated = isProfileDecorated;
exports.decorateOpenClawProfile = decorateOpenClawProfile;
exports.ensureProfileCleanExit = ensureProfileCleanExit;
var node_fs_1 = require("node:fs");
var node_path_1 = require("node:path");
var constants_js_1 = require("./constants.js");
function decoratedMarkerPath(userDataDir) {
  return node_path_1.default.join(userDataDir, ".openclaw-profile-decorated");
}
function safeReadJson(filePath) {
  try {
    if (!node_fs_1.default.existsSync(filePath)) {
      return null;
    }
    var raw = node_fs_1.default.readFileSync(filePath, "utf-8");
    var parsed = JSON.parse(raw);
    if (typeof parsed !== "object" || parsed === null || Array.isArray(parsed)) {
      return null;
    }
    return parsed;
  } catch (_a) {
    return null;
  }
}
function safeWriteJson(filePath, data) {
  node_fs_1.default.mkdirSync(node_path_1.default.dirname(filePath), { recursive: true });
  node_fs_1.default.writeFileSync(filePath, JSON.stringify(data, null, 2));
}
function setDeep(obj, keys, value) {
  var _a;
  var node = obj;
  for (var _i = 0, _b = keys.slice(0, -1); _i < _b.length; _i++) {
    var key = _b[_i];
    var next = node[key];
    if (typeof next !== "object" || next === null || Array.isArray(next)) {
      node[key] = {};
    }
    node = node[key];
  }
  node[(_a = keys[keys.length - 1]) !== null && _a !== void 0 ? _a : ""] = value;
}
function parseHexRgbToSignedArgbInt(hex) {
  var cleaned = hex.trim().replace(/^#/, "");
  if (!/^[0-9a-fA-F]{6}$/.test(cleaned)) {
    return null;
  }
  var rgb = Number.parseInt(cleaned, 16);
  var argbUnsigned = (0xff << 24) | rgb;
  // Chrome stores colors as signed 32-bit ints (SkColor).
  return argbUnsigned > 0x7fffffff ? argbUnsigned - 4294967296 : argbUnsigned;
}
function isProfileDecorated(userDataDir, desiredName, desiredColorHex) {
  var desiredColorInt = parseHexRgbToSignedArgbInt(desiredColorHex);
  var localStatePath = node_path_1.default.join(userDataDir, "Local State");
  var preferencesPath = node_path_1.default.join(userDataDir, "Default", "Preferences");
  var localState = safeReadJson(localStatePath);
  var profile = localState === null || localState === void 0 ? void 0 : localState.profile;
  var infoCache =
    typeof profile === "object" && profile !== null && !Array.isArray(profile)
      ? profile.info_cache
      : null;
  var info =
    typeof infoCache === "object" &&
    infoCache !== null &&
    !Array.isArray(infoCache) &&
    typeof infoCache.Default === "object" &&
    infoCache.Default !== null &&
    !Array.isArray(infoCache.Default)
      ? infoCache.Default
      : null;
  var prefs = safeReadJson(preferencesPath);
  var browserTheme = (function () {
    var browser = prefs === null || prefs === void 0 ? void 0 : prefs.browser;
    var theme =
      typeof browser === "object" && browser !== null && !Array.isArray(browser)
        ? browser.theme
        : null;
    return typeof theme === "object" && theme !== null && !Array.isArray(theme) ? theme : null;
  })();
  var autogeneratedTheme = (function () {
    var autogenerated = prefs === null || prefs === void 0 ? void 0 : prefs.autogenerated;
    var theme =
      typeof autogenerated === "object" && autogenerated !== null && !Array.isArray(autogenerated)
        ? autogenerated.theme
        : null;
    return typeof theme === "object" && theme !== null && !Array.isArray(theme) ? theme : null;
  })();
  var nameOk =
    typeof (info === null || info === void 0 ? void 0 : info.name) === "string"
      ? info.name === desiredName
      : true;
  if (desiredColorInt == null) {
    // If the user provided a non-#RRGGBB value, we can only do best-effort.
    return nameOk;
  }
  var localSeedOk =
    typeof (info === null || info === void 0 ? void 0 : info.profile_color_seed) === "number"
      ? info.profile_color_seed === desiredColorInt
      : false;
  var prefOk =
    (typeof (browserTheme === null || browserTheme === void 0
      ? void 0
      : browserTheme.user_color2) === "number" &&
      browserTheme.user_color2 === desiredColorInt) ||
    (typeof (autogeneratedTheme === null || autogeneratedTheme === void 0
      ? void 0
      : autogeneratedTheme.color) === "number" &&
      autogeneratedTheme.color === desiredColorInt);
  return nameOk && localSeedOk && prefOk;
}
/**
 * Best-effort profile decoration (name + lobster-orange). Chrome preference keys
 * vary by version; we keep this conservative and idempotent.
 */
function decorateOpenClawProfile(userDataDir, opts) {
  var _a, _b, _c, _d;
  var desiredName =
    (_a = opts === null || opts === void 0 ? void 0 : opts.name) !== null && _a !== void 0
      ? _a
      : constants_js_1.DEFAULT_OPENCLAW_BROWSER_PROFILE_NAME;
  var desiredColor = (
    (_b = opts === null || opts === void 0 ? void 0 : opts.color) !== null && _b !== void 0
      ? _b
      : constants_js_1.DEFAULT_OPENCLAW_BROWSER_COLOR
  ).toUpperCase();
  var desiredColorInt = parseHexRgbToSignedArgbInt(desiredColor);
  var localStatePath = node_path_1.default.join(userDataDir, "Local State");
  var preferencesPath = node_path_1.default.join(userDataDir, "Default", "Preferences");
  var localState = (_c = safeReadJson(localStatePath)) !== null && _c !== void 0 ? _c : {};
  // Common-ish shape: profile.info_cache.Default
  setDeep(localState, ["profile", "info_cache", "Default", "name"], desiredName);
  setDeep(localState, ["profile", "info_cache", "Default", "shortcut_name"], desiredName);
  setDeep(localState, ["profile", "info_cache", "Default", "user_name"], desiredName);
  // Color keys are best-effort (Chrome changes these frequently).
  setDeep(localState, ["profile", "info_cache", "Default", "profile_color"], desiredColor);
  setDeep(localState, ["profile", "info_cache", "Default", "user_color"], desiredColor);
  if (desiredColorInt != null) {
    // These are the fields Chrome actually uses for profile/avatar tinting.
    setDeep(
      localState,
      ["profile", "info_cache", "Default", "profile_color_seed"],
      desiredColorInt,
    );
    setDeep(
      localState,
      ["profile", "info_cache", "Default", "profile_highlight_color"],
      desiredColorInt,
    );
    setDeep(
      localState,
      ["profile", "info_cache", "Default", "default_avatar_fill_color"],
      desiredColorInt,
    );
    setDeep(
      localState,
      ["profile", "info_cache", "Default", "default_avatar_stroke_color"],
      desiredColorInt,
    );
  }
  safeWriteJson(localStatePath, localState);
  var prefs = (_d = safeReadJson(preferencesPath)) !== null && _d !== void 0 ? _d : {};
  setDeep(prefs, ["profile", "name"], desiredName);
  setDeep(prefs, ["profile", "profile_color"], desiredColor);
  setDeep(prefs, ["profile", "user_color"], desiredColor);
  if (desiredColorInt != null) {
    // Chrome refresh stores the autogenerated theme in these prefs (SkColor ints).
    setDeep(prefs, ["autogenerated", "theme", "color"], desiredColorInt);
    // User-selected browser theme color (pref name: browser.theme.user_color2).
    setDeep(prefs, ["browser", "theme", "user_color2"], desiredColorInt);
  }
  safeWriteJson(preferencesPath, prefs);
  try {
    node_fs_1.default.writeFileSync(
      decoratedMarkerPath(userDataDir),
      "".concat(Date.now(), "\n"),
      "utf-8",
    );
  } catch (_e) {
    // ignore
  }
}
function ensureProfileCleanExit(userDataDir) {
  var _a;
  var preferencesPath = node_path_1.default.join(userDataDir, "Default", "Preferences");
  var prefs = (_a = safeReadJson(preferencesPath)) !== null && _a !== void 0 ? _a : {};
  setDeep(prefs, ["exit_type"], "Normal");
  setDeep(prefs, ["exited_cleanly"], true);
  safeWriteJson(preferencesPath, prefs);
}
